<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#09090b">
  <title>ConectMe Tracker</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #09090b; --bg-subtle: #0f0f11; --surface: #18181b; --surface-hover: #1f1f23;
      --border: #27272a; --border-subtle: #1f1f23;
      --text: #fafafa; --text-secondary: #a1a1aa; --text-muted: #71717a;
      --primary: #6366f1; --primary-hover: #4f46e5;
      --success: #10b981; --success-bg: rgba(16, 185, 129, 0.1);
      --warning: #f59e0b; --warning-bg: rgba(245, 158, 11, 0.1);
      --danger: #ef4444; --danger-bg: rgba(239, 68, 68, 0.1);
      --info: #3b82f6; --info-bg: rgba(59, 130, 246, 0.1);
      --purple: #a855f7; --cyan: #06b6d4; --cyan-bg: rgba(6, 182, 212, 0.1);
    }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; line-height: 1.5; }
    .login-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 1.5rem; }
    .login-screen.hidden { display: none; }
    .login-card { width: 100%; max-width: 380px; background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 2.5rem; }
    .login-header { text-align: center; margin-bottom: 2rem; }
    .login-logo { width: 48px; height: 48px; background: linear-gradient(135deg, var(--primary), var(--purple)); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin: 0 auto 1rem; }
    .login-title { font-size: 1.25rem; font-weight: 600; }
    .login-subtitle { color: var(--text-muted); font-size: 0.875rem; margin-top: 0.25rem; }
    .login-error { background: var(--danger-bg); color: var(--danger); padding: 0.75rem 1rem; border-radius: 8px; font-size: 0.875rem; margin-bottom: 1rem; display: none; }
    .login-error.show { display: block; }
    .login-input { width: 100%; padding: 0.875rem 1rem; background: var(--bg); border: 1px solid var(--border); border-radius: 10px; color: var(--text); font-size: 0.9375rem; margin-bottom: 1rem; }
    .login-input:focus { outline: none; border-color: var(--primary); }
    .login-btn { width: 100%; padding: 0.875rem; background: var(--primary); border: none; border-radius: 10px; color: white; font-size: 0.9375rem; font-weight: 600; cursor: pointer; }
    .app { display: none; }
    .app.visible { display: flex; flex-direction: column; min-height: 100vh; }
    .header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 0 1.5rem; height: 64px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
    .header-left { display: flex; align-items: center; gap: 2rem; }
    .logo { display: flex; align-items: center; gap: 0.75rem; font-weight: 600; }
    .logo-icon { width: 32px; height: 32px; background: linear-gradient(135deg, var(--primary), var(--purple)); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 0.875rem; }
    .nav { display: flex; gap: 0.25rem; }
    .nav-item { padding: 0.5rem 1rem; background: transparent; border: none; border-radius: 8px; color: var(--text-secondary); font-size: 0.875rem; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; }
    .nav-item:hover { color: var(--text); background: var(--surface-hover); }
    .nav-item.active { color: var(--text); background: var(--bg); }
    .nav-badge { background: var(--danger); color: white; font-size: 0.6875rem; padding: 0.125rem 0.4rem; border-radius: 10px; font-weight: 600; animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
    .header-right { display: flex; align-items: center; gap: 1rem; }
    .today-date { color: var(--text-muted); font-size: 0.8125rem; }
    .user-menu { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.375rem 0.5rem; border-radius: 8px; }
    .user-menu:hover { background: var(--surface-hover); }
    .user-avatar { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8125rem; font-weight: 600; color: white; }
    .user-name { font-size: 0.875rem; font-weight: 500; }
    .main { flex: 1; padding: 1.5rem; max-width: 1400px; margin: 0 auto; width: 100%; }
    .summary-bar { display: flex; gap: 1.5rem; padding: 1rem 1.25rem; background: var(--surface); border: 1px solid var(--border); border-radius: 12px; margin-bottom: 1.5rem; flex-wrap: wrap; }
    .summary-item { display: flex; align-items: center; gap: 0.5rem; }
    .summary-value { font-weight: 700; font-size: 1.125rem; }
    .summary-label { font-size: 0.75rem; color: var(--text-muted); }
    .page-header { margin-bottom: 1.5rem; }
    .page-title { font-size: 1.5rem; font-weight: 600; margin-bottom: 0.25rem; }
    .page-subtitle { color: var(--text-muted); font-size: 0.875rem; }
    .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 0.75rem; }
    .client-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 1rem 1.25rem; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; gap: 0.75rem; }
    .client-card:hover { border-color: var(--primary); transform: translateY(-2px); }
    .client-card.has-issues { border-left: 3px solid var(--danger); }
    .client-card.all-done { border-left: 3px solid var(--success); }
    .client-card-header { display: flex; align-items: center; justify-content: space-between; }
    .client-card-name { display: flex; align-items: center; gap: 0.5rem; font-weight: 600; }
    .client-dot { width: 8px; height: 8px; border-radius: 50%; }
    .client-card-progress { font-size: 0.875rem; font-weight: 600; }
    .progress-bar-simple { height: 8px; background: var(--bg); border-radius: 4px; overflow: hidden; }
    .progress-fill-simple { height: 100%; border-radius: 4px; transition: width 0.3s; }
    .client-card-footer { display: flex; align-items: center; justify-content: space-between; font-size: 0.75rem; }
    .client-issues { color: var(--danger); font-weight: 500; }
    .client-ok { color: var(--success); font-weight: 500; }
    .client-sm { color: var(--text-muted); }
    .client-nav { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; overflow-x: auto; padding-bottom: 0.5rem; }
    .client-nav-item { padding: 0.5rem 1rem; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; font-size: 0.8125rem; font-weight: 500; white-space: nowrap; cursor: pointer; color: var(--text-secondary); }
    .client-nav-item:hover { border-color: var(--text-muted); color: var(--text); }
    .client-nav-item.active { background: var(--primary); border-color: var(--primary); color: white; }
    .days-list { display: flex; flex-direction: column; gap: 1rem; }
    .day-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
    .day-card.special { border-color: var(--warning); }
    .day-header { padding: 1rem 1.25rem; background: var(--bg-subtle); border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
    .day-date { font-weight: 600; display: flex; align-items: center; gap: 0.5rem; }
    .special-badge { font-size: 0.6875rem; background: var(--warning); color: #000; padding: 0.125rem 0.5rem; border-radius: 4px; font-weight: 600; }
    .day-status { font-size: 0.8125rem; color: var(--text-muted); }
    .day-items { display: flex; flex-direction: column; }
    .post-item { padding: 1rem 1.25rem; display: flex; align-items: center; justify-content: space-between; gap: 1rem; border-bottom: 1px solid var(--border-subtle); }
    .post-item:last-child { border-bottom: none; }
    .post-left { display: flex; align-items: center; gap: 1rem; flex: 1; }
    .post-type { font-size: 0.6875rem; font-weight: 600; padding: 0.25rem 0.625rem; border-radius: 4px; text-transform: uppercase; }
    .post-type.feed { background: rgba(99, 102, 241, 0.15); color: #818cf8; }
    .post-type.story { background: rgba(168, 85, 247, 0.15); color: #c084fc; }
    .post-info { flex: 1; }
    .post-desc { font-size: 0.875rem; font-weight: 500; margin-bottom: 0.125rem; }
    .post-meta { font-size: 0.75rem; color: var(--text-muted); }
    .post-status { display: flex; align-items: center; gap: 0.375rem; font-size: 0.8125rem; font-weight: 500; padding: 0.375rem 0.75rem; border-radius: 6px; }
    .post-status.pendente { background: var(--surface-hover); color: var(--text-muted); }
    .post-status.nao_agendou { background: var(--danger-bg); color: var(--danger); }
    .post-status.agendado { background: var(--info-bg); color: var(--info); }
    .post-status.verificar_ig { background: var(--warning-bg); color: var(--warning); }
    .post-status.publicado { background: var(--success-bg); color: var(--success); }
    .post-status.problema { background: var(--danger-bg); color: var(--danger); }
    .post-status.apontamento { background: var(--cyan-bg); color: var(--cyan); }
    .post-actions { display: flex; gap: 0.5rem; }
    .btn { padding: 0.5rem 1rem; border: none; border-radius: 8px; font-size: 0.8125rem; font-weight: 500; cursor: pointer; display: inline-flex; align-items: center; gap: 0.375rem; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-success { background: var(--success); color: white; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-warning { background: var(--warning); color: #000; }
    .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text-secondary); }
    .btn-sm { padding: 0.375rem 0.75rem; font-size: 0.75rem; }
    .alerts-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1rem; }
    .alert-card { background: var(--surface); border: 2px solid var(--warning); border-radius: 12px; padding: 1.25rem; animation: pulse-border 2s infinite; }
    @keyframes pulse-border { 0%, 100% { border-color: var(--warning); } 50% { border-color: rgba(245, 158, 11, 0.4); } }
    .alert-card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem; }
    .alert-client { display: flex; align-items: center; gap: 0.5rem; font-weight: 600; }
    .alert-time { font-size: 0.8125rem; color: var(--warning); font-weight: 600; }
    .alert-content { margin-bottom: 1rem; }
    .alert-desc { font-size: 0.9375rem; margin-bottom: 0.25rem; }
    .alert-meta { font-size: 0.75rem; color: var(--text-muted); }
    .alert-actions { display: flex; gap: 0.5rem; }
    .alert-actions .btn { flex: 1; }
    .issues-filters { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap; align-items: center; }
    .filter-select { padding: 0.5rem 0.75rem; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 0.8125rem; }
    .accordion { display: flex; flex-direction: column; gap: 0.75rem; }
    .accordion-item { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
    .accordion-item.has-danger { border-left: 3px solid var(--danger); }
    .accordion-item.has-warning { border-left: 3px solid var(--warning); }
    .accordion-header { padding: 1rem 1.25rem; display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
    .accordion-header:hover { background: var(--surface-hover); }
    .accordion-title { display: flex; align-items: center; gap: 0.75rem; font-weight: 600; }
    .accordion-count { font-size: 0.75rem; padding: 0.125rem 0.5rem; border-radius: 10px; font-weight: 600; }
    .accordion-count.danger { background: var(--danger); color: white; }
    .accordion-count.warning { background: var(--warning); color: #000; }
    .accordion-arrow { font-size: 0.75rem; color: var(--text-muted); transition: transform 0.2s; }
    .accordion-item.open .accordion-arrow { transform: rotate(180deg); }
    .accordion-content { display: none; border-top: 1px solid var(--border); }
    .accordion-item.open .accordion-content { display: block; }
    .accordion-actions { display: flex; gap: 0.5rem; padding: 0.75rem 1.25rem; background: var(--bg-subtle); border-bottom: 1px solid var(--border); }
    .issue-row { padding: 0.875rem 1.25rem; display: flex; align-items: center; gap: 1rem; border-bottom: 1px solid var(--border-subtle); }
    .issue-row:last-child { border-bottom: none; }
    .issue-type-badge { font-size: 0.625rem; font-weight: 600; padding: 0.125rem 0.5rem; border-radius: 4px; text-transform: uppercase; }
    .issue-type-badge.nao-agendou { background: var(--danger-bg); color: var(--danger); }
    .issue-type-badge.apontamento { background: var(--cyan-bg); color: var(--cyan); }
    .issue-type-badge.problema { background: var(--warning-bg); color: var(--warning); }
    .issue-type-badge.urgente { background: var(--danger); color: white; }
    .issue-info { flex: 1; }
    .issue-title { font-size: 0.875rem; font-weight: 500; }
    .issue-detail { font-size: 0.75rem; color: var(--text-muted); }
    .issue-age { font-size: 0.6875rem; color: var(--danger); margin-left: 0.5rem; }
    .health-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
    .health-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
    .health-card.critical { border-left: 4px solid var(--danger); }
    .health-card.warning { border-left: 4px solid var(--warning); }
    .health-card.ok { border-left: 4px solid var(--success); }
    .health-header { padding: 1rem 1.25rem; display: flex; align-items: center; justify-content: space-between; }
    .health-client { display: flex; align-items: center; gap: 0.625rem; }
    .health-status-icon { font-size: 1.25rem; }
    .health-name { font-weight: 600; }
    .health-progress { font-weight: 700; }
    .health-bar { height: 4px; background: var(--bg); }
    .health-bar-fill { height: 100%; }
    .health-summary { padding: 0.75rem 1.25rem; font-size: 0.8125rem; color: var(--text-secondary); background: var(--bg-subtle); }
    .health-issues { display: none; border-top: 1px solid var(--border); }
    .health-card.expanded .health-issues { display: block; }
    .health-issue-row { padding: 0.625rem 1.25rem; font-size: 0.8125rem; border-bottom: 1px solid var(--border-subtle); display: flex; align-items: center; gap: 0.5rem; }
    .health-toggle { padding: 0.625rem 1.25rem; font-size: 0.75rem; color: var(--primary); cursor: pointer; text-align: center; }
    .report-section { margin-bottom: 2rem; }
    .report-section-title { font-size: 1rem; font-weight: 600; margin-bottom: 1rem; }
    .report-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1rem; }
    .report-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem; }
    .report-card-title { font-size: 0.875rem; font-weight: 600; margin-bottom: 1rem; }
    .report-list { display: flex; flex-direction: column; gap: 0.625rem; }
    .report-item { display: flex; align-items: center; justify-content: space-between; padding-bottom: 0.625rem; border-bottom: 1px solid var(--border-subtle); }
    .report-item:last-child { border-bottom: none; padding-bottom: 0; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.75); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 1.5rem; }
    .modal-overlay.show { display: flex; }
    .modal { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; width: 100%; max-width: 480px; max-height: 90vh; overflow-y: auto; }
    .modal.wide { max-width: 600px; }
    .modal-header { padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
    .modal-title { font-size: 1.125rem; font-weight: 600; }
    .modal-close { width: 32px; height: 32px; border: none; background: var(--bg); border-radius: 8px; color: var(--text-muted); cursor: pointer; font-size: 1.125rem; }
    .modal-body { padding: 1.5rem; }
    .modal-info { margin-bottom: 1.5rem; }
    .modal-client { font-weight: 600; font-size: 1.125rem; margin-bottom: 0.25rem; }
    .modal-meta { font-size: 0.875rem; color: var(--text-muted); }
    .modal-section { margin-bottom: 1.5rem; }
    .modal-section-title { font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); margin-bottom: 0.75rem; }
    .modal-inputs { display: flex; flex-direction: column; gap: 0.75rem; }
    .modal-row { display: flex; gap: 0.75rem; }
    .modal-row > * { flex: 1; }
    .input-group { display: flex; flex-direction: column; gap: 0.375rem; }
    .input-label { font-size: 0.8125rem; color: var(--text-secondary); }
    .input-field { padding: 0.625rem 0.875rem; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 0.875rem; font-family: inherit; }
    .input-field:focus { outline: none; border-color: var(--primary); }
    .checklist { display: flex; flex-direction: column; gap: 0.5rem; }
    .check-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; }
    .check-item.checked { background: var(--success-bg); border-color: var(--success); }
    .check-box { width: 20px; height: 20px; border: 2px solid var(--border); border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; }
    .check-item.checked .check-box { background: var(--success); border-color: var(--success); color: white; }
    .modal-footer { padding: 1.25rem 1.5rem; border-top: 1px solid var(--border); display: flex; gap: 0.75rem; }
    .modal-footer .btn { flex: 1; padding: 0.75rem; }
    .cobranca-text { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 1rem; font-family: monospace; font-size: 0.8125rem; white-space: pre-wrap; max-height: 300px; overflow-y: auto; line-height: 1.6; }
    .cobranca-history { margin-top: 1rem; padding: 0.75rem; background: var(--info-bg); border-radius: 8px; font-size: 0.8125rem; color: var(--info); }
    .toast { position: fixed; bottom: 1.5rem; right: 1.5rem; background: var(--surface); border: 1px solid var(--success); padding: 0.875rem 1.25rem; border-radius: 10px; font-size: 0.875rem; transform: translateY(100px); opacity: 0; transition: all 0.3s; z-index: 1001; }
    .toast.show { transform: translateY(0); opacity: 1; }
    .empty-state { text-align: center; padding: 4rem 2rem; color: var(--text-muted); }
    .empty-icon { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }
    @media (max-width: 768px) {
      .header { padding: 0 1rem; } .nav { display: none; } .main { padding: 1rem; }
      .dashboard-grid, .alerts-grid, .health-grid { grid-template-columns: 1fr; }
      .post-item { flex-wrap: wrap; } .post-actions { width: 100%; margin-top: 0.5rem; } .post-actions .btn { flex: 1; }
    }
    .mobile-nav { display: none; position: fixed; bottom: 0; left: 0; right: 0; background: var(--surface); border-top: 1px solid var(--border); padding: 0.5rem; z-index: 100; }
    .mobile-nav-inner { display: flex; justify-content: space-around; }
    .mobile-nav-item { display: flex; flex-direction: column; align-items: center; gap: 0.25rem; padding: 0.5rem; border: none; background: none; color: var(--text-muted); font-size: 0.625rem; cursor: pointer; position: relative; }
    .mobile-nav-item.active { color: var(--primary); }
    .mobile-nav-item span:first-child { font-size: 1.25rem; }
    .mobile-nav-badge { position: absolute; top: 0; right: 0; background: var(--danger); color: white; font-size: 0.5rem; padding: 0.125rem 0.25rem; border-radius: 6px; }
    @media (max-width: 768px) { .mobile-nav { display: block; } .app.visible { padding-bottom: 70px; } }
  </style>
</head>
<body>
<div class="login-screen" id="loginScreen">
  <div class="login-card">
    <div class="login-header"><div class="login-logo">ğŸ“Š</div><div class="login-title">ConectMe Tracker</div><div class="login-subtitle">Sistema de Monitoramento</div></div>
    <div class="login-error" id="loginError">E-mail nÃ£o encontrado</div>
    <input type="email" class="login-input" id="loginEmail" placeholder="seu@conectme.digital">
    <button class="login-btn" id="loginBtn">Entrar</button>
  </div>
</div>
<div class="app" id="app">
  <header class="header">
    <div class="header-left">
      <div class="logo"><div class="logo-icon">ğŸ“Š</div><span>ConectMe</span></div>
      <nav class="nav">
        <button class="nav-item active" data-page="dashboard">Dashboard</button>
        <button class="nav-item" data-page="alerts">Alertas<span class="nav-badge" id="alertsBadge" style="display:none">0</span></button>
        <button class="nav-item" data-page="issues">PendÃªncias<span class="nav-badge" id="issuesBadge" style="display:none">0</span></button>
        <button class="nav-item" data-page="report">RelatÃ³rio</button>
      </nav>
    </div>
    <div class="header-right">
      <span class="today-date" id="todayDate"></span>
      <div class="user-menu" onclick="logout()"><div class="user-avatar" id="userAvatar">A</div><span class="user-name" id="userName">Alec</span></div>
    </div>
  </header>
  <main class="main">
    <div class="summary-bar" id="summaryBar">
      <div class="summary-item"><span class="summary-value" id="sumTotal">0</span><span class="summary-label">Total</span></div>
      <div class="summary-item"><span class="summary-value" style="color:var(--success)" id="sumOk">0</span><span class="summary-label">OK</span></div>
      <div class="summary-item"><span class="summary-value" style="color:var(--info)" id="sumAgendado">0</span><span class="summary-label">Agendados</span></div>
      <div class="summary-item"><span class="summary-value" style="color:var(--warning)" id="sumVerificar">0</span><span class="summary-label">Verificar</span></div>
      <div class="summary-item"><span class="summary-value" style="color:var(--danger)" id="sumPendencias">0</span><span class="summary-label">PendÃªncias</span></div>
    </div>
    <div class="page" id="page-dashboard"><div class="page-header"><h1 class="page-title">Dashboard</h1><p class="page-subtitle">Clique em um cliente para ver detalhes</p></div><div class="dashboard-grid" id="dashboardGrid"></div></div>
    <div class="page" id="page-client" style="display:none"><div class="page-header"><h1 class="page-title" id="clientPageTitle">Cliente</h1><p class="page-subtitle" id="clientPageSubtitle">Posts e stories</p></div><div class="client-nav" id="clientNav"></div><div class="days-list" id="daysList"></div></div>
    <div class="page" id="page-alerts" style="display:none"><div class="page-header"><h1 class="page-title">ğŸ”” Alertas do Dia</h1><p class="page-subtitle">Posts para verificar no Instagram agora</p></div><div class="alerts-grid" id="alertsGrid"></div><div class="empty-state" id="alertsEmpty" style="display:none"><div class="empty-icon">âœ…</div><div class="empty-text">Nenhum alerta no momento</div></div></div>
    <div class="page" id="page-issues" style="display:none"><div class="page-header"><h1 class="page-title">âš ï¸ PendÃªncias</h1><p class="page-subtitle">Itens que precisam de atenÃ§Ã£o</p></div><div class="issues-filters" id="issuesFilters"></div><div class="accordion" id="issuesAccordion"></div><div class="empty-state" id="issuesEmpty" style="display:none"><div class="empty-icon">ğŸ‰</div><div class="empty-text">Nenhuma pendÃªncia</div></div></div>
    <div class="page" id="page-report" style="display:none"><div class="page-header"><h1 class="page-title">ğŸ“Š RelatÃ³rio</h1><p class="page-subtitle">SaÃºde dos clientes e resumos</p></div><div id="reportContent"></div></div>
  </main>
  <div class="mobile-nav"><div class="mobile-nav-inner">
    <button class="mobile-nav-item active" data-page="dashboard"><span>ğŸ </span><span>Dashboard</span></button>
    <button class="mobile-nav-item" data-page="alerts"><span>ğŸ””</span><span>Alertas</span><span class="mobile-nav-badge" id="mobileAlertsBadge" style="display:none">0</span></button>
    <button class="mobile-nav-item" data-page="issues"><span>âš ï¸</span><span>PendÃªncias</span><span class="mobile-nav-badge" id="mobileIssuesBadge" style="display:none">0</span></button>
    <button class="mobile-nav-item" data-page="report"><span>ğŸ“Š</span><span>RelatÃ³rio</span></button>
  </div></div>
</div>
<div class="modal-overlay" id="modalOverlay"><div class="modal" id="modal"><div class="modal-header"><h3 class="modal-title" id="modalTitle">Modal</h3><button class="modal-close" onclick="closeModal()">Ã—</button></div><div class="modal-body" id="modalBody"></div><div class="modal-footer" id="modalFooter"></div></div></div>
<div class="toast" id="toast">âœ“ Salvo</div>
<script>
const SUPABASE_URL = 'https://jxxhypanwiqigtaptrrp.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp4eGh5cGFud2lxaWd0YXB0cnJwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MTgyMzQsImV4cCI6MjA4MjA5NDIzNH0.IKd0n-abux653kQspkE-uyoQwVXV5hvCzF_SA103auw';
const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let items=[], clients=[], team=[], activities=[], cobrancas=[];
let currentUser=null, currentPage='dashboard', currentClient=null, currentItem=null;
let issueFilterClient='', issueFilterSM='';
let expandedClients=new Set(), expandedHealthCards=new Set();
let modalChecks={horario:false,visual:false,texto:false};

document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('loginBtn').addEventListener('click', handleLogin);
  document.getElementById('loginEmail').addEventListener('keypress', e => { if(e.key==='Enter') handleLogin(); });
  document.querySelectorAll('.nav-item, .mobile-nav-item').forEach(btn => btn.addEventListener('click', () => navigateTo(btn.dataset.page)));
  document.getElementById('modalOverlay').addEventListener('click', e => { if(e.target===e.currentTarget) closeModal(); });
  updateTodayDate(); setInterval(updateTodayDate, 60000);
  checkAuth();
});

function updateTodayDate() { const n=new Date(); document.getElementById('todayDate').textContent=n.toLocaleDateString('pt-BR',{weekday:'short',day:'2-digit',month:'2-digit',timeZone:'America/Sao_Paulo'}); }
function getToday() { const n=new Date(); return `${String(n.getDate()).padStart(2,'0')}/${String(n.getMonth()+1).padStart(2,'0')}`; }
function getNow() { return new Date(); }

async function handleLogin() {
  const email=document.getElementById('loginEmail').value.trim().toLowerCase();
  const error=document.getElementById('loginError');
  if(!email) return;
  error.classList.remove('show');
  try {
    const {data} = await db.from('team_members').select('*').eq('email',email).eq('active',true).maybeSingle();
    if(!data) { error.classList.add('show'); return; }
    currentUser=data; localStorage.setItem('cmt_user',JSON.stringify(data)); showApp();
  } catch(err) { error.textContent='Erro de conexÃ£o'; error.classList.add('show'); }
}

function checkAuth() { const s=localStorage.getItem('cmt_user'); if(s) { try { currentUser=JSON.parse(s); showApp(); } catch { localStorage.removeItem('cmt_user'); } } }
function logout() { if(confirm('Sair?')) { localStorage.removeItem('cmt_user'); location.reload(); } }
function showApp() {
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('app').classList.add('visible');
  document.getElementById('userName').textContent=currentUser.name;
  document.getElementById('userAvatar').textContent=currentUser.name[0];
  document.getElementById('userAvatar').style.background=currentUser.color;
  init();
}

async function loadData() {
  const [iR,cR,tR,aR,coR] = await Promise.all([
    db.from('items').select('*').order('scheduled_date').order('type'),
    db.from('clients').select('*').order('name'),
    db.from('team_members').select('*').eq('active',true),
    db.from('activity_log').select('*').order('created_at',{ascending:false}).limit(100),
    db.from('cobrancas').select('*').order('created_at',{ascending:false}).limit(100)
  ]);
  items=iR.data||[]; clients=cR.data||[]; team=tR.data||[]; activities=aR.data||[]; cobrancas=coR.data||[];
  await checkAndUpdateStatuses();
  updateSummary(); updateBadges(); renderCurrentPage();
}

async function checkAndUpdateStatuses() {
  const today=getToday(), now=getNow(), ch=now.getHours(), cm=now.getMinutes();
  for(const i of items) {
    if(i.status==='agendado') {
      const isT=i.scheduled_date===today, isP=isDatePast(i.scheduled_date,today);
      if(isP||isT) {
        let upd=isP;
        if(isT&&i.scheduled_time) { const [h,m]=i.scheduled_time.split(':').map(Number); upd=(ch*60+cm)>=(h*60+(m||0)+10); }
        else if(isT) upd=true;
        if(upd) { await db.from('items').update({status:'verificar_ig'}).eq('id',i.id); i.status='verificar_ig'; }
      }
    }
  }
}

function isDatePast(d,t) { const [d1,m1]=d.split('/').map(Number),[d2,m2]=t.split('/').map(Number); const y1=m1===1?2025:2024, y2=m2===1?2025:2024; return new Date(y1,m1-1,d1)<new Date(y2,m2-1,d2); }
function setupRealtime() { db.channel('ch').on('postgres_changes',{event:'*',schema:'public',table:'items'},()=>loadData()).on('postgres_changes',{event:'*',schema:'public',table:'cobrancas'},()=>loadData()).subscribe(); }
function getMyItems() { return currentUser.role==='gestor' ? items.filter(i=>i.gestor===currentUser.name) : items; }
function getMyClients() { return currentUser.role==='gestor' ? clients.filter(c=>c.gestor===currentUser.name) : clients; }
function getIssues(cn=null) { let m=getMyItems(); if(cn) m=m.filter(i=>i.client===cn); return m.filter(i=>i.status==='nao_agendou'||i.status==='problema'||(i.apontamento_tipo&&!i.apontamento_resolvido)||(i.scheduled_date==='05/01'&&i.status==='pendente')); }
function getDaysOld(i) { if(!i.updated_at) return 0; return Math.floor((new Date()-new Date(i.updated_at))/(1000*60*60*24)); }

function navigateTo(page, data=null) {
  currentPage=page;
  document.querySelectorAll('.page').forEach(p=>p.style.display='none');
  document.querySelectorAll('.nav-item,.mobile-nav-item').forEach(n=>n.classList.remove('active'));
  if(page==='client'&&data) { currentClient=data; document.getElementById('page-client').style.display='block'; renderClientPage(); }
  else { document.getElementById(`page-${page}`).style.display='block'; document.querySelectorAll(`[data-page="${page}"]`).forEach(n=>n.classList.add('active')); renderCurrentPage(); }
}

function renderCurrentPage() { switch(currentPage) { case 'dashboard': renderDashboard(); break; case 'alerts': renderAlerts(); break; case 'issues': renderIssues(); break; case 'report': renderReport(); break; case 'client': renderClientPage(); break; } }

function updateSummary() {
  const m=getMyItems();
  document.getElementById('sumTotal').textContent=m.length;
  document.getElementById('sumOk').textContent=m.filter(i=>i.status==='publicado').length;
  document.getElementById('sumAgendado').textContent=m.filter(i=>i.status==='agendado').length;
  document.getElementById('sumVerificar').textContent=m.filter(i=>i.status==='verificar_ig').length;
  document.getElementById('sumPendencias').textContent=getIssues().length;
}

function updateBadges() {
  const al=getMyItems().filter(i=>i.status==='verificar_ig').length, is=getIssues().length;
  ['alertsBadge','mobileAlertsBadge'].forEach(id=>{ const e=document.getElementById(id); if(e){e.textContent=al;e.style.display=al>0?'inline':'none';} });
  ['issuesBadge','mobileIssuesBadge'].forEach(id=>{ const e=document.getElementById(id); if(e){e.textContent=is;e.style.display=is>0?'inline':'none';} });
}

function renderDashboard() {
  const mc=getMyClients(), g=document.getElementById('dashboardGrid');
  g.innerHTML=mc.map(c=>{
    const ci=items.filter(i=>i.client===c.name), t=ci.length, d=ci.filter(i=>i.status==='publicado').length, is=getIssues(c.name).length, ad=d===t, pct=t>0?Math.round((d/t)*100):0;
    let cc='',bc='var(--primary)';
    if(ad){cc='all-done';bc='var(--success)';}else if(is>0){cc='has-issues';bc='var(--danger)';}
    return `<div class="client-card ${cc}" onclick="navigateTo('client','${c.name}')"><div class="client-card-header"><div class="client-card-name"><div class="client-dot" style="background:${c.color}"></div><span>${c.name}</span></div><span class="client-card-progress">${d}/${t}</span></div><div class="progress-bar-simple"><div class="progress-fill-simple" style="width:${pct}%;background:${bc}"></div></div><div class="client-card-footer">${is>0?`<span class="client-issues">âš ï¸ ${is} pendÃªncia${is>1?'s':''}</span>`:''}${ad?`<span class="client-ok">âœ“ Completo</span>`:''}${!is&&!ad?'<span></span>':''}<span class="client-sm">${c.social_media}</span></div></div>`;
  }).join('');
}

function renderClientPage() {
  const mc=getMyClients(), cd=clients.find(c=>c.name===currentClient);
  document.getElementById('clientPageTitle').textContent=currentClient;
  document.getElementById('clientPageSubtitle').textContent=`Social Media: ${cd?.social_media||'-'}`;
  document.getElementById('clientNav').innerHTML=mc.map(c=>`<button class="client-nav-item ${c.name===currentClient?'active':''}" onclick="navigateTo('client','${c.name}')">${c.name}</button>`).join('');
  const ci=items.filter(i=>i.client===currentClient), dates=[...new Set(ci.map(i=>i.scheduled_date))];
  const sd=dates.sort((a,b)=>{const [d1,m1]=a.split('/').map(Number),[d2,m2]=b.split('/').map(Number);if(m1!==m2)return m1===1?1:-1;return d1-d2;});
  document.getElementById('daysList').innerHTML=sd.map(dt=>{
    const di=ci.filter(i=>i.scheduled_date===dt), sp=di.some(i=>i.is_special), ad=di.every(i=>i.status==='publicado'), dc=di.filter(i=>i.status==='publicado').length;
    return `<div class="day-card ${sp?'special':''}"><div class="day-header"><div class="day-date">ğŸ“… ${dt}${sp?'<span class="special-badge">ESPECIAL</span>':''}</div><div class="day-status">${ad?'âœ“ Completo':`${dc}/${di.length}`}</div></div><div class="day-items">${di.map(i=>renderPostItem(i)).join('')}</div></div>`;
  }).join('');
}

function renderPostItem(i) {
  const sl={pendente:{t:'Pendente',ic:'â—‹'},nao_agendou:{t:'NÃ£o agendou',ic:'âœ—'},agendado:{t:'Agendado',ic:'â—'},apontamento:{t:'Apontamento',ic:'âš¡'},verificar_ig:{t:'Verificar IG',ic:'ğŸ””'},publicado:{t:'Publicado',ic:'âœ“'},problema:{t:'Problema',ic:'!'}};
  const s=sl[i.status]||sl.pendente, meta=[];
  if(i.platform)meta.push(i.platform.charAt(0).toUpperCase()+i.platform.slice(1));
  if(i.scheduled_time)meta.push(i.scheduled_time);
  if(i.verificado_por)meta.push(`por ${i.verificado_por}`);
  return `<div class="post-item"><div class="post-left"><span class="post-type ${i.type.toLowerCase()}">${i.type}</span><div class="post-info"><div class="post-desc">${i.description}</div><div class="post-meta">${meta.length>0?meta.join(' â€¢ '):'Sem informaÃ§Ãµes'}</div></div></div><span class="post-status ${i.status}">${s.ic} ${s.t}</span><div class="post-actions">${getActionButton(i)}</div></div>`;
}

function getActionButton(i) {
  switch(i.status) {
    case 'pendente': return `<button class="btn btn-primary btn-sm" onclick="openVerifyModal(${i.id})">Verificar</button>`;
    case 'agendado': case 'apontamento': case 'publicado': return `<button class="btn btn-outline btn-sm" onclick="openEditModal(${i.id})">Editar</button>`;
    case 'verificar_ig': return `<button class="btn btn-success btn-sm" onclick="markPublished(${i.id},true)">OK</button><button class="btn btn-danger btn-sm" onclick="markPublished(${i.id},false)">Erro</button>`;
    case 'nao_agendou': case 'problema': return `<button class="btn btn-primary btn-sm" onclick="resolveIssue(${i.id})">Resolver</button>`;
    default: return '';
  }
}

function renderAlerts() {
  const m=getMyItems().filter(i=>i.status==='verificar_ig'), g=document.getElementById('alertsGrid'), e=document.getElementById('alertsEmpty');
  if(m.length===0){g.innerHTML='';e.style.display='block';return;}
  e.style.display='none';
  g.innerHTML=m.map(i=>{const c=clients.find(x=>x.name===i.client);return `<div class="alert-card"><div class="alert-card-header"><div class="alert-client"><div class="client-dot" style="background:${c?.color||'#666'}"></div><span>${i.client}</span><span class="post-type ${i.type.toLowerCase()}">${i.type}</span></div><span class="alert-time">${i.scheduled_time||i.scheduled_date}</span></div><div class="alert-content"><div class="alert-desc">${i.description}</div><div class="alert-meta">${i.platform?i.platform.charAt(0).toUpperCase()+i.platform.slice(1):''} â€¢ ${i.scheduled_date}</div></div><div class="alert-actions"><button class="btn btn-success" onclick="markPublished(${i.id},true)">âœ“ OK</button><button class="btn btn-danger" onclick="markPublished(${i.id},false)">âœ— Problema</button></div></div>`;}).join('');
}

function renderIssues() {
  const ct=document.getElementById('issuesAccordion'), e=document.getElementById('issuesEmpty'), fl=document.getElementById('issuesFilters');
  const ai=getIssues();
  if(ai.length===0){ct.innerHTML='';fl.innerHTML='';e.style.display='block';return;}
  e.style.display='none';
  const bc={};ai.forEach(i=>{if(!bc[i.client])bc[i.client]=[];bc[i.client].push(i);});
  const sms=[...new Set(ai.map(i=>i.social_media))];
  fl.innerHTML=`<select class="filter-select" onchange="issueFilterClient=this.value;renderIssues()"><option value="">Todos os clientes</option>${Object.keys(bc).sort().map(c=>`<option value="${c}" ${issueFilterClient===c?'selected':''}>${c}</option>`).join('')}</select><select class="filter-select" onchange="issueFilterSM=this.value;renderIssues()"><option value="">Todas Social Medias</option>${sms.map(s=>`<option value="${s}" ${issueFilterSM===s?'selected':''}>${s}</option>`).join('')}</select><span style="color:var(--text-muted);font-size:0.8125rem;margin-left:auto">${ai.length} pendÃªncia${ai.length>1?'s':''}</span>`;
  let fc=Object.entries(bc);
  if(issueFilterClient)fc=fc.filter(([n])=>n===issueFilterClient);
  if(issueFilterSM)fc=fc.map(([n,is])=>[n,is.filter(i=>i.social_media===issueFilterSM)]).filter(([,is])=>is.length>0);
  fc.sort((a,b)=>b[1].length-a[1].length);
  ct.innerHTML=fc.map(([cn,ci])=>{
    const c=clients.find(x=>x.name===cn), op=expandedClients.has(cn), hd=ci.some(i=>i.status==='nao_agendou'||i.status==='problema');
    return `<div class="accordion-item ${op?'open':''} ${hd?'has-danger':'has-warning'}"><div class="accordion-header" onclick="toggleAccordion('${cn}')"><div class="accordion-title"><div class="client-dot" style="background:${c?.color||'#666'}"></div><span>${cn}</span><span class="accordion-count ${hd?'danger':'warning'}">${ci.length}</span></div><span class="accordion-arrow">â–¼</span></div><div class="accordion-content"><div class="accordion-actions"><button class="btn btn-outline btn-sm" onclick="openCobrancaModal('${cn}')">ğŸ“‹ Gerar CobranÃ§a WhatsApp</button></div>${ci.map(i=>renderIssueRow(i)).join('')}</div></div>`;
  }).join('');
}

function renderIssueRow(i) {
  let tb='nao-agendou',tt='NÃ£o agendou';
  if(i.status==='problema'){tb='problema';tt='Problema';}else if(i.apontamento_tipo){tb='apontamento';tt=i.apontamento_tipo;}else if(i.scheduled_date==='05/01'&&i.status==='pendente'){tb='urgente';tt='Agendar atÃ© 31/12';}
  const da=getDaysOld(i), at=da>0?`hÃ¡ ${da} dia${da>1?'s':''}`:'';
  return `<div class="issue-row"><span class="post-type ${i.type.toLowerCase()}">${i.type}</span><span class="issue-type-badge ${tb}">${tt}</span><div class="issue-info"><div class="issue-title">${i.description}</div><div class="issue-detail">${i.scheduled_date} ${i.scheduled_time?'â€¢ '+i.scheduled_time:''} ${i.problema_descricao?'â€¢ '+i.problema_descricao:''} ${i.apontamento_descricao?'â€¢ '+i.apontamento_descricao:''} ${at?`<span class="issue-age">${at}</span>`:''}</div></div><button class="btn btn-primary btn-sm" onclick="resolveIssue(${i.id})">Resolver</button></div>`;
}

function toggleAccordion(cn) { expandedClients.has(cn)?expandedClients.delete(cn):expandedClients.add(cn); renderIssues(); }

function renderReport() {
  const m=getMyItems(), mc=getMyClients();
  const ch=mc.map(c=>{const ci=m.filter(i=>i.client===c.name),t=ci.length,d=ci.filter(i=>i.status==='publicado').length,is=getIssues(c.name),pct=t>0?Math.round((d/t)*100):0;let st='ok';if(is.length>3)st='critical';else if(is.length>0)st='warning';return {client:c,total:t,done:d,issues:is,pct,status:st};});
  ch.sort((a,b)=>{const o={critical:0,warning:1,ok:2};return o[a.status]-o[b.status]||b.issues.length-a.issues.length;});
  const bsm={};m.forEach(i=>{if(!bsm[i.social_media])bsm[i.social_media]={total:0,done:0,issues:0};bsm[i.social_media].total++;if(i.status==='publicado')bsm[i.social_media].done++;});
  getIssues().forEach(i=>{if(bsm[i.social_media])bsm[i.social_media].issues++;});
  const ct=document.getElementById('reportContent');
  ct.innerHTML=`<div class="report-section"><div class="report-section-title">ğŸ¥ SaÃºde dos Clientes</div><p style="font-size:0.8125rem;color:var(--text-muted);margin-bottom:1rem">Ordenado por quantidade de problemas. Clique para ver detalhes.</p><div class="health-grid">${ch.map(h=>renderHealthCard(h)).join('')}</div></div><div class="report-section"><div class="report-section-title">ğŸ‘¥ Por Social Media</div><div class="report-grid">${Object.entries(bsm).map(([n,d])=>`<div class="report-card"><div class="report-card-title">${n}</div><div class="report-list"><div class="report-item"><span>Publicados</span><span style="color:var(--success);font-weight:600">${d.done}/${d.total}</span></div><div class="report-item"><span>PendÃªncias</span><span style="color:${d.issues>0?'var(--danger)':'var(--text-muted)'};font-weight:600">${d.issues}</span></div><div class="report-item"><span>Progresso</span><span style="font-weight:600">${Math.round((d.done/d.total)*100)}%</span></div></div></div>`).join('')}</div></div><div class="report-section"><div class="report-section-title">ğŸ“Š Resumo Geral</div><div class="report-grid"><div class="report-card"><div class="report-card-title">Totais</div><div class="report-list"><div class="report-item"><span>Total</span><span style="font-weight:600">${m.length}</span></div><div class="report-item"><span>Publicados</span><span style="color:var(--success);font-weight:600">${m.filter(i=>i.status==='publicado').length}</span></div><div class="report-item"><span>Agendados</span><span style="color:var(--info);font-weight:600">${m.filter(i=>i.status==='agendado').length}</span></div><div class="report-item"><span>PendÃªncias</span><span style="color:var(--danger);font-weight:600">${getIssues().length}</span></div></div></div><div class="report-card"><div class="report-card-title">Por Tipo</div><div class="report-list"><div class="report-item"><span>Feed</span><span style="font-weight:600">${m.filter(i=>i.type==='FEED'&&i.status==='publicado').length}/${m.filter(i=>i.type==='FEED').length}</span></div><div class="report-item"><span>Story</span><span style="font-weight:600">${m.filter(i=>i.type==='STORY'&&i.status==='publicado').length}/${m.filter(i=>i.type==='STORY').length}</span></div></div></div></div></div>`;
}

function renderHealthCard(h) {
  const ex=expandedHealthCards.has(h.client.name), si=h.status==='critical'?'ğŸ”´':h.status==='warning'?'âš ï¸':'âœ…', bc=h.status==='critical'?'var(--danger)':h.status==='warning'?'var(--warning)':'var(--success)';
  let sm='';if(h.status==='ok')sm=h.done===h.total?'Tudo concluÃ­do!':`${h.pct}% concluÃ­do`;else{const t=[];const na=h.issues.filter(i=>i.status==='nao_agendou').length,pr=h.issues.filter(i=>i.status==='problema').length,ap=h.issues.filter(i=>i.apontamento_tipo&&!i.apontamento_resolvido).length;if(na)t.push(`${na} nÃ£o agendou`);if(pr)t.push(`${pr} problema${pr>1?'s':''}`);if(ap)t.push(`${ap} apontamento${ap>1?'s':''}`);sm=t.join(' â€¢ ');}
  return `<div class="health-card ${h.status} ${ex?'expanded':''}"><div class="health-header"><div class="health-client"><span class="health-status-icon">${si}</span><span class="health-name">${h.client.name}</span></div><span class="health-progress">${h.done}/${h.total}</span></div><div class="health-bar"><div class="health-bar-fill" style="width:${h.pct}%;background:${bc}"></div></div><div class="health-summary">${sm}</div>${h.issues.length>0?`<div class="health-toggle" onclick="toggleHealthCard('${h.client.name}')">${ex?'â–² Fechar':'â–¼ Ver pendÃªncias'}</div><div class="health-issues">${h.issues.map(i=>`<div class="health-issue-row"><span class="post-type ${i.type.toLowerCase()}">${i.type}</span><span>${i.description}</span><span style="color:var(--text-muted);margin-left:auto">${i.scheduled_date}</span></div>`).join('')}</div>`:''}</div>`;
}

function toggleHealthCard(cn) { expandedHealthCards.has(cn)?expandedHealthCards.delete(cn):expandedHealthCards.add(cn); renderReport(); }

function openCobrancaModal(cn) {
  const c=clients.find(x=>x.name===cn), ci=getIssues(cn), lc=cobrancas.find(x=>x.client===cn);
  const ds=new Date().toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});
  let tx=`ğŸš¨ PENDÃŠNCIAS - ${cn}\nğŸ“… ${ds}\n\n`;
  const na=ci.filter(i=>i.status==='nao_agendou'), pr=ci.filter(i=>i.status==='problema'), ap=ci.filter(i=>i.apontamento_tipo&&!i.apontamento_resolvido), ur=ci.filter(i=>i.scheduled_date==='05/01'&&i.status==='pendente');
  if(ur.length>0){tx+=`ğŸš¨ URGENTE - AGENDAR ATÃ‰ 31/12:\n`;ur.forEach(i=>{tx+=`â€¢ ${i.type} ${i.scheduled_date} - ${i.description}\n`;});tx+=`\n`;}
  if(na.length>0){tx+=`âŒ NÃƒO AGENDOU:\n`;na.forEach(i=>{tx+=`â€¢ ${i.type} ${i.scheduled_date} - ${i.description}\n`;});tx+=`\n`;}
  if(ap.length>0){tx+=`âš¡ APONTAMENTOS PARA CORRIGIR:\n`;ap.forEach(i=>{tx+=`â€¢ ${i.type} ${i.scheduled_date} - ${i.apontamento_tipo}: ${i.apontamento_descricao}\n`;});tx+=`\n`;}
  if(pr.length>0){tx+=`âš ï¸ PROBLEMAS NA PUBLICAÃ‡ÃƒO:\n`;pr.forEach(i=>{tx+=`â€¢ ${i.type} ${i.scheduled_date} - ${i.problema_descricao||i.description}\n`;});tx+=`\n`;}
  tx+=`Por favor verificar e corrigir. ğŸ™`;
  document.getElementById('modal').classList.add('wide');
  document.getElementById('modalTitle').textContent=`ğŸ“‹ CobranÃ§a - ${cn}`;
  document.getElementById('modalBody').innerHTML=`<div class="modal-info"><div class="modal-meta">Social Media: ${c?.social_media||'-'}</div></div><div class="modal-section"><div class="modal-section-title">Texto para copiar</div><div class="cobranca-text" id="cobrancaText">${tx}</div></div>${lc?`<div class="cobranca-history">ğŸ“Œ Ãšltima cobranÃ§a: ${new Date(lc.created_at).toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'})} por ${lc.cobrado_por}</div>`:''}`;
  document.getElementById('modalFooter').innerHTML=`<button class="btn btn-outline" onclick="closeModal()">Fechar</button><button class="btn btn-primary" onclick="copyCobranca()">ğŸ“‹ Copiar</button><button class="btn btn-success" onclick="saveCobranca('${cn}','${c?.social_media||''}')">âœ“ Marcar Cobrado</button>`;
  document.getElementById('modalOverlay').classList.add('show');
}

function copyCobranca() { navigator.clipboard.writeText(document.getElementById('cobrancaText').textContent).then(()=>toast('Copiado!')); }

async function saveCobranca(cn,sm) {
  const tx=document.getElementById('cobrancaText').textContent, ci=getIssues(cn);
  await db.from('cobrancas').insert({client:cn,social_media:sm,items_cobrados:ci.map(i=>({id:i.id,type:i.type,date:i.scheduled_date,desc:i.description})),texto_cobranca:tx,cobrado_por:currentUser.name});
  await logActivity(null,cn,null,'registrou cobranÃ§a',`${ci.length} pendÃªncias`);
  closeModal(); toast('CobranÃ§a registrada!'); loadData();
}

function openVerifyModal(id) {
  currentItem=items.find(i=>i.id===id);if(!currentItem)return;
  modalChecks={horario:currentItem.check_horario||false,visual:currentItem.check_visual||false,texto:currentItem.check_texto||false};
  document.getElementById('modal').classList.remove('wide');
  document.getElementById('modalTitle').textContent='Verificar Agendamento';
  document.getElementById('modalBody').innerHTML=`<div class="modal-info"><div class="modal-client">${currentItem.client}</div><div class="modal-meta">${currentItem.type} â€¢ ${currentItem.description} â€¢ ${currentItem.scheduled_date}</div></div><div class="modal-section"><div class="modal-section-title">InformaÃ§Ãµes</div><div class="modal-inputs"><div class="modal-row"><div class="input-group"><label class="input-label">Plataforma *</label><select class="input-field" id="modalPlatform"><option value="">Selecione</option><option value="ekyte" ${currentItem.platform==='ekyte'?'selected':''}>Ekyte</option><option value="meta" ${currentItem.platform==='meta'?'selected':''}>Meta Business</option><option value="direto" ${currentItem.platform==='direto'?'selected':''}>Direto</option></select></div><div class="input-group"><label class="input-label">HorÃ¡rio</label><input type="time" class="input-field" id="modalTime" value="${currentItem.scheduled_time||''}"></div></div><div class="input-group"><label class="input-label">Data</label><input type="text" class="input-field" id="modalDate" value="${currentItem.scheduled_date}" placeholder="dd/mm"></div></div></div><div class="modal-section"><div class="modal-section-title">Checklist</div><div class="checklist"><div class="check-item ${modalChecks.horario?'checked':''}" onclick="toggleModalCheck('horario')"><div class="check-box">${modalChecks.horario?'âœ“':''}</div><span class="check-label">ğŸ• HorÃ¡rio correto</span></div><div class="check-item ${modalChecks.visual?'checked':''}" onclick="toggleModalCheck('visual')"><div class="check-box">${modalChecks.visual?'âœ“':''}</div><span class="check-label">ğŸ¨ Visual OK</span></div><div class="check-item ${modalChecks.texto?'checked':''}" onclick="toggleModalCheck('texto')"><div class="check-box">${modalChecks.texto?'âœ“':''}</div><span class="check-label">ğŸ“ Texto OK</span></div></div></div><div class="modal-section"><div class="modal-section-title">ObservaÃ§Ãµes</div><textarea class="input-field" id="modalObs" rows="2" placeholder="Opcional...">${currentItem.observacoes||''}</textarea></div>`;
  document.getElementById('modalFooter').innerHTML=`<button class="btn btn-outline" onclick="closeModal()">Cancelar</button><button class="btn btn-danger" onclick="markNotScheduled()">NÃ£o agendou</button><button class="btn btn-success" onclick="saveVerification()">Salvar âœ“</button>`;
  document.getElementById('modalOverlay').classList.add('show');
}

function toggleModalCheck(f) { modalChecks[f]=!modalChecks[f]; openVerifyModal(currentItem.id); }

async function saveVerification() {
  const pl=document.getElementById('modalPlatform').value, tm=document.getElementById('modalTime').value, dt=document.getElementById('modalDate').value, ob=document.getElementById('modalObs').value;
  if(!pl){toast('Selecione a plataforma');return;}
  const up={platform:pl,scheduled_time:tm||null,scheduled_date:dt,observacoes:ob||null,check_horario:modalChecks.horario,check_visual:modalChecks.visual,check_texto:modalChecks.texto,status:'agendado',verificado_por:currentUser.name,verificado_em:new Date().toISOString(),updated_by:currentUser.name,updated_at:new Date().toISOString()};
  await db.from('items').update(up).eq('id',currentItem.id);
  await logActivity(currentItem.id,currentItem.client,currentItem.type,'verificou agendamento',`${pl} ${tm||''}`);
  closeModal(); toast('VerificaÃ§Ã£o salva!'); loadData();
}

async function markNotScheduled() {
  if(!confirm('Confirma que NÃƒO foi agendado?'))return;
  await db.from('items').update({status:'nao_agendou',updated_by:currentUser.name,updated_at:new Date().toISOString()}).eq('id',currentItem.id);
  await logActivity(currentItem.id,currentItem.client,currentItem.type,'marcou nÃ£o agendou');
  closeModal(); toast('Marcado'); loadData();
}

async function markPublished(id,ok) {
  if(ok) {
    await db.from('items').update({status:'publicado',publicado_por:currentUser.name,publicado_em:new Date().toISOString(),updated_by:currentUser.name,updated_at:new Date().toISOString()}).eq('id',id);
    const i=items.find(x=>x.id===id); await logActivity(id,i?.client,i?.type,'confirmou publicaÃ§Ã£o OK');
    toast('PublicaÃ§Ã£o confirmada!');
  } else {
    const d=prompt('Descreva o problema:'); if(!d)return;
    await db.from('items').update({status:'problema',problema_descricao:d,updated_by:currentUser.name,updated_at:new Date().toISOString()}).eq('id',id);
    const i=items.find(x=>x.id===id); await logActivity(id,i?.client,i?.type,'registrou problema',d);
    toast('Problema registrado');
  }
  loadData();
}

async function resolveIssue(id) {
  const i=items.find(x=>x.id===id);if(!i)return;
  if(i.status==='nao_agendou'||i.status==='pendente') openVerifyModal(id);
  else if(i.status==='problema') {
    if(confirm('Problema resolvido?')) {
      await db.from('items').update({status:'publicado',problema_resolvido:true,publicado_por:currentUser.name,publicado_em:new Date().toISOString(),updated_by:currentUser.name,updated_at:new Date().toISOString()}).eq('id',id);
      await logActivity(id,i.client,i.type,'resolveu problema'); toast('Resolvido!'); loadData();
    }
  } else if(i.apontamento_tipo) {
    if(confirm('Apontamento corrigido?')) {
      await db.from('items').update({apontamento_resolvido:true,apontamento_resolvido_por:currentUser.name,apontamento_resolvido_em:new Date().toISOString(),updated_by:currentUser.name,updated_at:new Date().toISOString()}).eq('id',id);
      await logActivity(id,i.client,i.type,'resolveu apontamento'); toast('Resolvido!'); loadData();
    }
  }
}

function openEditModal(id) {
  currentItem=items.find(i=>i.id===id);if(!currentItem)return;
  document.getElementById('modal').classList.remove('wide');
  document.getElementById('modalTitle').textContent='Editar PublicaÃ§Ã£o';
  document.getElementById('modalBody').innerHTML=`<div class="modal-section"><div class="modal-section-title">InformaÃ§Ãµes</div><div class="modal-inputs"><div class="modal-row"><div class="input-group"><label class="input-label">Tipo</label><select class="input-field" id="editType"><option value="FEED" ${currentItem.type==='FEED'?'selected':''}>Feed</option><option value="STORY" ${currentItem.type==='STORY'?'selected':''}>Story</option></select></div><div class="input-group"><label class="input-label">Data</label><input type="text" class="input-field" id="editDate" value="${currentItem.scheduled_date}" placeholder="dd/mm"></div></div><div class="input-group"><label class="input-label">DescriÃ§Ã£o</label><input type="text" class="input-field" id="editDesc" value="${currentItem.description}"></div><div class="modal-row"><div class="input-group"><label class="input-label">Plataforma</label><select class="input-field" id="editPlatform"><option value="">Selecione</option><option value="ekyte" ${currentItem.platform==='ekyte'?'selected':''}>Ekyte</option><option value="meta" ${currentItem.platform==='meta'?'selected':''}>Meta</option><option value="direto" ${currentItem.platform==='direto'?'selected':''}>Direto</option></select></div><div class="input-group"><label class="input-label">HorÃ¡rio</label><input type="time" class="input-field" id="editTime" value="${currentItem.scheduled_time||''}"></div></div><div class="input-group"><label class="input-label">Status</label><select class="input-field" id="editStatus"><option value="pendente" ${currentItem.status==='pendente'?'selected':''}>Pendente</option><option value="agendado" ${currentItem.status==='agendado'?'selected':''}>Agendado</option><option value="verificar_ig" ${currentItem.status==='verificar_ig'?'selected':''}>Verificar IG</option><option value="publicado" ${currentItem.status==='publicado'?'selected':''}>Publicado</option><option value="nao_agendou" ${currentItem.status==='nao_agendou'?'selected':''}>NÃ£o Agendou</option><option value="problema" ${currentItem.status==='problema'?'selected':''}>Problema</option></select></div></div></div>`;
  document.getElementById('modalFooter').innerHTML=`<button class="btn btn-outline" onclick="closeModal()">Cancelar</button><button class="btn btn-primary" onclick="saveEdit()">Salvar</button>`;
  document.getElementById('modalOverlay').classList.add('show');
}

async function saveEdit() {
  const up={type:document.getElementById('editType').value,description:document.getElementById('editDesc').value,scheduled_date:document.getElementById('editDate').value,scheduled_time:document.getElementById('editTime').value||null,platform:document.getElementById('editPlatform').value||null,status:document.getElementById('editStatus').value,updated_by:currentUser.name,updated_at:new Date().toISOString()};
  await db.from('items').update(up).eq('id',currentItem.id);
  await logActivity(currentItem.id,currentItem.client,up.type,'editou publicaÃ§Ã£o');
  closeModal(); toast('Salvo!'); loadData();
}

function closeModal() { document.getElementById('modalOverlay').classList.remove('show'); document.getElementById('modal').classList.remove('wide'); currentItem=null; }

async function logActivity(iid,cl,tp,ac,dt=null) { await db.from('activity_log').insert({item_id:iid,client:cl,type:tp,action:ac,details:dt,user_name:currentUser.name}); }
function toast(m) { const t=document.getElementById('toast'); t.textContent='âœ“ '+m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2500); }

async function init() { await loadData(); setupRealtime(); setInterval(()=>checkAndUpdateStatuses(),60000); }
</script>
</body>
</html>
