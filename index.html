<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üìä ConectMe Tracker</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --bg: #0f0f0f;
      --card: #1a1a1a;
      --card-hover: #222;
      --border: #333;
      --text: #fff;
      --text-muted: #888;
      
      --aguardando: #666;
      --agendado: #3b82f6;
      --verificado: #06b6d4;
      --publicar: #f97316;
      --publicado: #22c55e;
      --paula: #a855f7;
      --problema: #ef4444;
      --especial: #eab308;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* ========== LOGIN ========== */
    .login {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    .login.hidden { display: none; }
    .login-box {
      background: var(--card);
      border-radius: 20px;
      padding: 2.5rem;
      width: 100%;
      max-width: 360px;
      text-align: center;
    }
    .login-logo { font-size: 3rem; margin-bottom: 0.5rem; }
    .login-title { font-size: 1.3rem; font-weight: 700; margin-bottom: 0.25rem; }
    .login-sub { color: var(--text-muted); font-size: 0.85rem; margin-bottom: 1.5rem; }
    .login-input {
      width: 100%;
      padding: 0.9rem 1rem;
      background: var(--bg);
      border: 2px solid var(--border);
      border-radius: 12px;
      color: var(--text);
      font-size: 1rem;
      margin-bottom: 1rem;
    }
    .login-input:focus { outline: none; border-color: var(--agendado); }
    .login-btn {
      width: 100%;
      padding: 0.9rem;
      background: var(--agendado);
      border: none;
      border-radius: 12px;
      color: white;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
    }
    .login-btn:hover { opacity: 0.9; }
    .login-error {
      background: rgba(239,68,68,0.2);
      color: var(--problema);
      padding: 0.75rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      font-size: 0.85rem;
      display: none;
    }
    .login-error.show { display: block; }

    /* ========== APP ========== */
    .app { display: none; }
    .app.visible { display: block; }

    /* ========== HEADER ========== */
    .header {
      background: var(--card);
      padding: 0.75rem 1.25rem;
      position: sticky;
      top: 0;
      z-index: 100;
      border-bottom: 1px solid var(--border);
    }
    .header-inner {
      max-width: 1600px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .logo {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 700;
    }
    .logo-icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--agendado), var(--paula));
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .user-info {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.8rem;
      color: white;
      cursor: pointer;
    }
    .user-name { font-weight: 600; font-size: 0.9rem; }

    /* ========== ALERTA DE NOTIFICA√á√ÉO ========== */
    .notification-bar {
      background: linear-gradient(90deg, var(--publicar), #ea580c);
      padding: 0.75rem 1.25rem;
      display: none;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      animation: pulse-bg 1s infinite;
      cursor: pointer;
    }
    .notification-bar.show { display: flex; }
    .notification-bar span { font-weight: 600; }
    @keyframes pulse-bg {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.85; }
    }

    /* ========== FILTROS ========== */
    .filters {
      background: var(--card);
      padding: 0.75rem 1.25rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      align-items: center;
    }
    .filter-btn {
      padding: 0.5rem 1rem;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 20px;
      color: var(--text-muted);
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }
    .filter-btn:hover { border-color: var(--text-muted); color: var(--text); }
    .filter-btn.active { background: var(--agendado); border-color: var(--agendado); color: white; }
    .filter-btn .count {
      background: rgba(255,255,255,0.2);
      padding: 0.1rem 0.4rem;
      border-radius: 10px;
      font-size: 0.7rem;
    }
    .filter-select {
      padding: 0.5rem 0.75rem;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 0.8rem;
    }

    /* ========== STATS ========== */
    .stats {
      display: flex;
      gap: 0.5rem;
      padding: 1rem 1.25rem;
      max-width: 1600px;
      margin: 0 auto;
      flex-wrap: wrap;
    }
    .stat {
      flex: 1;
      min-width: 100px;
      background: var(--card);
      border-radius: 12px;
      padding: 0.75rem 1rem;
      text-align: center;
    }
    .stat-value { font-size: 1.5rem; font-weight: 700; }
    .stat-label { font-size: 0.65rem; color: var(--text-muted); text-transform: uppercase; }

    /* ========== GRID DE CARDS ========== */
    .main {
      max-width: 1600px;
      margin: 0 auto;
      padding: 0 1.25rem 2rem;
    }
    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 0.75rem;
    }

    /* ========== CARD ========== */
    .card {
      background: var(--card);
      border-radius: 16px;
      padding: 1rem;
      border: 2px solid transparent;
      transition: all 0.15s;
    }
    .card:hover { background: var(--card-hover); }
    .card.especial { border-color: var(--especial); }
    .card.publicar-agora {
      border-color: var(--publicar);
      animation: card-pulse 1.5s infinite;
    }
    @keyframes card-pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.4); }
      50% { box-shadow: 0 0 20px 5px rgba(249, 115, 22, 0.2); }
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 0.75rem;
    }
    .card-client {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .client-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }
    .client-name { font-weight: 700; font-size: 0.95rem; }
    .card-type {
      padding: 0.2rem 0.6rem;
      border-radius: 20px;
      font-size: 0.7rem;
      font-weight: 600;
    }
    .card-type.feed { background: rgba(168,85,247,0.2); color: #c084fc; }
    .card-type.story { background: rgba(249,115,22,0.2); color: #fb923c; }

    .card-content {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }
    .card-content.especial { color: var(--especial); font-weight: 500; }

    .card-info {
      display: flex;
      gap: 1rem;
      margin-bottom: 0.75rem;
      font-size: 0.8rem;
    }
    .card-info-item {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      color: var(--text-muted);
    }
    .card-info-item strong { color: var(--text); }

    /* ========== STATUS BADGE ========== */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      padding: 0.35rem 0.75rem;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-bottom: 0.75rem;
    }
    .status-badge.aguardando { background: rgba(102,102,102,0.3); color: #999; }
    .status-badge.agendado { background: rgba(59,130,246,0.2); color: #60a5fa; }
    .status-badge.verificado { background: rgba(6,182,212,0.2); color: #22d3ee; }
    .status-badge.publicar { background: rgba(249,115,22,0.3); color: #fb923c; }
    .status-badge.publicado { background: rgba(34,197,94,0.2); color: #4ade80; }
    .status-badge.paula { background: rgba(168,85,247,0.2); color: #c084fc; }
    .status-badge.problema { background: rgba(239,68,68,0.2); color: #f87171; }

    /* ========== CHECKLIST ========== */
    .checklist {
      display: flex;
      gap: 0.4rem;
      margin-bottom: 0.75rem;
      flex-wrap: wrap;
    }
    .check-item {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      padding: 0.3rem 0.6rem;
      background: var(--bg);
      border-radius: 6px;
      font-size: 0.7rem;
      cursor: pointer;
      border: 1px solid var(--border);
      transition: all 0.15s;
    }
    .check-item:hover { border-color: var(--text-muted); }
    .check-item.checked {
      background: rgba(34,197,94,0.2);
      border-color: var(--publicado);
      color: var(--publicado);
    }
    .check-item input { display: none; }

    /* ========== BOT√ïES DE A√á√ÉO ========== */
    .card-actions {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    .action-btn {
      flex: 1;
      min-width: 80px;
      padding: 0.6rem 0.75rem;
      border: none;
      border-radius: 10px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.3rem;
      transition: all 0.15s;
    }
    .action-btn:hover { transform: scale(1.02); }
    .action-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .action-btn.primary { background: var(--agendado); color: white; }
    .action-btn.success { background: var(--publicado); color: white; }
    .action-btn.warning { background: var(--publicar); color: white; }
    .action-btn.danger { background: var(--problema); color: white; }
    .action-btn.purple { background: var(--paula); color: white; }
    .action-btn.outline {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-muted);
    }

    /* ========== INPUTS ========== */
    .card-inputs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
      flex-wrap: wrap;
    }
    .mini-select {
      padding: 0.4rem 0.6rem;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 0.75rem;
      min-width: 90px;
    }
    .mini-input {
      padding: 0.4rem 0.6rem;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 0.75rem;
      width: 70px;
    }
    .mini-select:focus, .mini-input:focus { outline: none; border-color: var(--agendado); }

    /* ========== EMPTY STATE ========== */
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--text-muted);
    }
    .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; }

    /* ========== TOAST ========== */
    .toast {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      background: var(--card);
      border: 1px solid var(--publicado);
      padding: 0.75rem 1.25rem;
      border-radius: 12px;
      font-size: 0.9rem;
      z-index: 1000;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s;
    }
    .toast.show { transform: translateY(0); opacity: 1; }

    /* ========== SECTION TITLE ========== */
    .section-title {
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    /* ========== RESPONSIVE ========== */
    @media (max-width: 600px) {
      .cards-grid { grid-template-columns: 1fr; }
      .stats { flex-direction: column; }
      .stat { min-width: 100%; }
    }
  </style>
</head>
<body>

<!-- LOGIN -->
<div class="login" id="loginScreen">
  <div class="login-box">
    <div class="login-logo">üìä</div>
    <div class="login-title">ConectMe Tracker</div>
    <div class="login-sub">Monitoramento de Posts</div>
    <div class="login-error" id="loginError">E-mail n√£o encontrado</div>
    <input type="email" class="login-input" id="loginEmail" placeholder="seu@conectme.digital">
    <button class="login-btn" id="loginBtn">Entrar</button>
  </div>
</div>

<!-- APP -->
<div class="app" id="app">
  
  <!-- HEADER -->
  <header class="header">
    <div class="header-inner">
      <div class="logo">
        <div class="logo-icon">üìä</div>
        <span>ConectMe Tracker</span>
      </div>
      <div class="user-info">
        <span class="user-name" id="userName">Alec</span>
        <div class="user-avatar" id="userAvatar" onclick="logout()">A</div>
      </div>
    </div>
  </header>

  <!-- NOTIFICATION BAR -->
  <div class="notification-bar" id="notificationBar" onclick="filterByStatus('publicar_agora')">
    <span>üîî</span>
    <span id="notificationText">3 posts precisam ser verificados no Instagram AGORA!</span>
  </div>

  <!-- FILTERS -->
  <div class="filters">
    <button class="filter-btn active" data-filter="todos">üìã Todos</button>
    <button class="filter-btn" data-filter="pendentes">‚è≥ Pendentes <span class="count" id="countPendentes">0</span></button>
    <button class="filter-btn" data-filter="verificar">üîç Verificar <span class="count" id="countVerificar">0</span></button>
    <button class="filter-btn" data-filter="publicar">üîî Publicar Agora <span class="count" id="countPublicar">0</span></button>
    <button class="filter-btn" data-filter="concluidos">‚úÖ Conclu√≠dos <span class="count" id="countConcluidos">0</span></button>
    <select class="filter-select" id="filterClient">
      <option value="">Todos os clientes</option>
    </select>
    <select class="filter-select" id="filterDate">
      <option value="">Todas as datas</option>
    </select>
  </div>

  <!-- STATS -->
  <div class="stats">
    <div class="stat">
      <div class="stat-value" id="statTotal">0</div>
      <div class="stat-label">Total</div>
    </div>
    <div class="stat">
      <div class="stat-value" style="color:var(--aguardando)" id="statAguardando">0</div>
      <div class="stat-label">Aguardando</div>
    </div>
    <div class="stat">
      <div class="stat-value" style="color:var(--agendado)" id="statAgendado">0</div>
      <div class="stat-label">Agendado</div>
    </div>
    <div class="stat">
      <div class="stat-value" style="color:var(--verificado)" id="statVerificado">0</div>
      <div class="stat-label">Verificado</div>
    </div>
    <div class="stat">
      <div class="stat-value" style="color:var(--publicar)" id="statPublicar">0</div>
      <div class="stat-label">Publicar Agora</div>
    </div>
    <div class="stat">
      <div class="stat-value" style="color:var(--publicado)" id="statPublicado">0</div>
      <div class="stat-label">Publicado</div>
    </div>
  </div>

  <!-- MAIN -->
  <main class="main">
    <div class="cards-grid" id="cardsGrid"></div>
    <div class="empty-state" id="emptyState" style="display:none">
      <div class="empty-state-icon">üéâ</div>
      <div>Nenhum post para mostrar</div>
    </div>
  </main>

  <div class="toast" id="toast">‚úì Salvo!</div>
</div>

<!-- AUDIO NOTIFICATION -->
<audio id="notificationSound" preload="auto">
  <source src="data:audio/wav;base64,UklGRl9vT19teleVBAAAAFdBVkVmbXQgEAAAA..." type="audio/wav">
</audio>

<script>
// CONFIG
const SUPABASE_URL = 'https://jxxhypanwiqigtaptrrp.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp4eGh5cGFud2lxaWd0YXB0cnJwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY1MTgyMzQsImV4cCI6MjA4MjA5NDIzNH0.IKd0n-abux653kQspkE-uyoQwVXV5hvCzF_SA103auw';
const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// STATE
let items = [];
let clients = [];
let currentUser = null;
let currentFilter = 'todos';
let currentClient = '';
let currentDate = '';

// DATES
const ALL_DATES = ['22/12', '23/12', '24/12', '25/12', '26/12', '29/12', '30/12', '31/12', '01/01', '02/01', '05/01'];

// ========== LOGIN ==========
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('loginBtn').addEventListener('click', handleLogin);
  document.getElementById('loginEmail').addEventListener('keypress', e => { if (e.key === 'Enter') handleLogin(); });
  
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentFilter = btn.dataset.filter;
      renderCards();
    });
  });
  
  document.getElementById('filterClient').addEventListener('change', e => { currentClient = e.target.value; renderCards(); });
  document.getElementById('filterDate').addEventListener('change', e => { currentDate = e.target.value; renderCards(); });
  
  checkAuth();
});

async function handleLogin() {
  const email = document.getElementById('loginEmail').value.trim().toLowerCase();
  const error = document.getElementById('loginError');
  if (!email) return;
  
  error.classList.remove('show');
  
  try {
    const { data } = await db.from('team_members').select('*').eq('email', email).eq('active', true).maybeSingle();
    if (!data) { error.classList.add('show'); return; }
    currentUser = data;
    localStorage.setItem('tracker_user', JSON.stringify(data));
    showApp();
  } catch (err) {
    console.error(err);
    error.textContent = 'Erro de conex√£o';
    error.classList.add('show');
  }
}

function checkAuth() {
  const saved = localStorage.getItem('tracker_user');
  if (saved) {
    try { currentUser = JSON.parse(saved); showApp(); }
    catch { localStorage.removeItem('tracker_user'); }
  }
}

function logout() {
  if (confirm('Sair do sistema?')) {
    localStorage.removeItem('tracker_user');
    location.reload();
  }
}

function showApp() {
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('app').classList.add('visible');
  document.getElementById('userName').textContent = currentUser.name;
  document.getElementById('userAvatar').textContent = currentUser.name[0];
  document.getElementById('userAvatar').style.background = currentUser.color;
  init();
}

// ========== DATA ==========
async function loadData() {
  try {
    const [itemsRes, clientsRes] = await Promise.all([
      db.from('items').select('*').order('scheduled_date').order('client'),
      db.from('clients').select('*').order('name')
    ]);
    
    items = itemsRes.data || [];
    clients = clientsRes.data || [];
    
    // Atualizar status dos posts baseado em data/hora atual
    await updatePostStatuses();
    
    populateFilters();
    renderCards();
    renderStats();
    checkNotifications();
  } catch (err) {
    console.error('Erro ao carregar:', err);
  }
}

async function updatePostStatuses() {
  const now = new Date();
  const today = `${String(now.getDate()).padStart(2, '0')}/${String(now.getMonth() + 1).padStart(2, '0')}`;
  const currentHour = now.getHours();
  
  for (const item of items) {
    // Se est√° verificado e chegou a data/hora, mudar para publicar_agora
    if (item.status === 'verificado' && item.scheduled_date) {
      const [day, month] = item.scheduled_date.split('/');
      const itemMonth = parseInt(month);
      const itemDay = parseInt(day);
      const todayParts = today.split('/');
      const todayDay = parseInt(todayParts[0]);
      const todayMonth = parseInt(todayParts[1]);
      
      // Comparar datas considerando virada de ano
      let shouldNotify = false;
      
      if (itemMonth === 12 && todayMonth === 12 && itemDay <= todayDay) shouldNotify = true;
      if (itemMonth === 1 && todayMonth === 1 && itemDay <= todayDay) shouldNotify = true;
      if (itemMonth === 12 && todayMonth === 1) shouldNotify = true; // J√° passou
      
      if (shouldNotify) {
        // Verificar hor√°rio se tiver
        if (item.scheduled_time) {
          const [hour] = item.scheduled_time.split(':');
          if (parseInt(hour) <= currentHour) {
            await updateStatus(item.id, 'publicar_agora', true);
          }
        } else {
          await updateStatus(item.id, 'publicar_agora', true);
        }
      }
    }
  }
}

function setupRealtime() {
  db.channel('changes')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'items' }, payload => {
      if (payload.eventType === 'UPDATE') {
        const idx = items.findIndex(i => i.id === payload.new.id);
        if (idx !== -1) items[idx] = payload.new;
      }
      renderCards();
      renderStats();
      checkNotifications();
    })
    .subscribe();
}

// ========== UPDATE ==========
async function updateStatus(id, newStatus, silent = false) {
  const updates = {
    status: newStatus,
    updated_by: currentUser.name,
    updated_at: new Date().toISOString()
  };
  
  if (newStatus === 'verificado') {
    updates.verificado_por = currentUser.name;
    updates.verificado_em = new Date().toISOString();
  }
  if (newStatus === 'publicado') {
    updates.publicado_verificado_por = currentUser.name;
    updates.publicado_verificado_em = new Date().toISOString();
    updates.publicado_ok = true;
  }
  if (newStatus === 'paula_ok') {
    updates.paula_verificou_em = new Date().toISOString();
  }
  
  await db.from('items').update(updates).eq('id', id);
  
  const item = items.find(i => i.id === id);
  if (item) Object.assign(item, updates);
  
  if (!silent) {
    renderCards();
    renderStats();
    toast('Salvo!');
  }
}

async function updateField(id, field, value) {
  const updates = {
    [field]: value,
    updated_by: currentUser.name,
    updated_at: new Date().toISOString()
  };
  
  await db.from('items').update(updates).eq('id', id);
  
  const item = items.find(i => i.id === id);
  if (item) item[field] = value;
  
  renderCards();
}

async function toggleCheck(id, field) {
  const item = items.find(i => i.id === id);
  if (!item) return;
  await updateField(id, field, !item[field]);
}

async function markAsProblem(id) {
  const desc = prompt('Descreva o problema:');
  if (!desc) return;
  
  await db.from('items').update({
    status: 'publicado',
    publicado_ok: false,
    problema_desc: desc,
    publicado_verificado_por: currentUser.name,
    publicado_verificado_em: new Date().toISOString()
  }).eq('id', id);
  
  const item = items.find(i => i.id === id);
  if (item) {
    item.status = 'publicado';
    item.publicado_ok = false;
    item.problema_desc = desc;
  }
  
  renderCards();
  renderStats();
  toast('Problema registrado');
}

// ========== FILTERS ==========
function populateFilters() {
  const clientSelect = document.getElementById('filterClient');
  const uniqueClients = [...new Set(getMyItems().map(i => i.client))].sort();
  clientSelect.innerHTML = '<option value="">Todos os clientes</option>' +
    uniqueClients.map(c => `<option value="${c}">${c}</option>`).join('');
  
  const dateSelect = document.getElementById('filterDate');
  dateSelect.innerHTML = '<option value="">Todas as datas</option>' +
    ALL_DATES.map(d => `<option value="${d}">${d}</option>`).join('');
}

function getMyItems() {
  if (currentUser.role === 'gestor') {
    return items.filter(i => i.gestor === currentUser.name);
  }
  if (currentUser.role === 'social_media') {
    return items.filter(i => i.social_media === currentUser.name);
  }
  return items; // Paula v√™ tudo
}

function getFilteredItems() {
  let filtered = getMyItems();
  
  if (currentClient) filtered = filtered.filter(i => i.client === currentClient);
  if (currentDate) filtered = filtered.filter(i => i.scheduled_date === currentDate);
  
  switch (currentFilter) {
    case 'pendentes':
      filtered = filtered.filter(i => i.status === 'aguardando');
      break;
    case 'verificar':
      filtered = filtered.filter(i => i.status === 'agendado');
      break;
    case 'publicar':
      filtered = filtered.filter(i => i.status === 'publicar_agora');
      break;
    case 'concluidos':
      filtered = filtered.filter(i => ['publicado', 'paula_ok'].includes(i.status));
      break;
  }
  
  return filtered;
}

// ========== RENDER ==========
function renderStats() {
  const my = getMyItems();
  document.getElementById('statTotal').textContent = my.length;
  document.getElementById('statAguardando').textContent = my.filter(i => i.status === 'aguardando').length;
  document.getElementById('statAgendado').textContent = my.filter(i => i.status === 'agendado').length;
  document.getElementById('statVerificado').textContent = my.filter(i => i.status === 'verificado').length;
  document.getElementById('statPublicar').textContent = my.filter(i => i.status === 'publicar_agora').length;
  document.getElementById('statPublicado').textContent = my.filter(i => ['publicado', 'paula_ok'].includes(i.status)).length;
  
  document.getElementById('countPendentes').textContent = my.filter(i => i.status === 'aguardando').length;
  document.getElementById('countVerificar').textContent = my.filter(i => i.status === 'agendado').length;
  document.getElementById('countPublicar').textContent = my.filter(i => i.status === 'publicar_agora').length;
  document.getElementById('countConcluidos').textContent = my.filter(i => ['publicado', 'paula_ok'].includes(i.status)).length;
}

function renderCards() {
  const grid = document.getElementById('cardsGrid');
  const empty = document.getElementById('emptyState');
  const filtered = getFilteredItems();
  
  if (filtered.length === 0) {
    grid.innerHTML = '';
    empty.style.display = 'block';
    return;
  }
  
  empty.style.display = 'none';
  grid.innerHTML = filtered.map(item => renderCard(item)).join('');
}

function renderCard(item) {
  const clientColor = clients.find(c => c.name === item.client)?.color || '#666';
  const isSpecial = item.is_special;
  const isPublicarAgora = item.status === 'publicar_agora';
  
  const statusLabels = {
    'aguardando': { text: '‚è≥ Aguardando agendar', class: 'aguardando' },
    'agendado': { text: 'üîç Verificar agendamento', class: 'agendado' },
    'verificado': { text: '‚úì Verificado, aguardando publicar', class: 'verificado' },
    'publicar_agora': { text: 'üîî VERIFICAR NO INSTAGRAM!', class: 'publicar' },
    'publicado': { text: item.publicado_ok ? '‚úÖ Publicado OK' : '‚ùå Problema', class: item.publicado_ok ? 'publicado' : 'problema' },
    'paula_ok': { text: 'üëÅÔ∏è Paula conferiu', class: 'paula' }
  };
  
  const status = statusLabels[item.status] || statusLabels.aguardando;
  const canEdit = currentUser.role !== 'social_media' || item.status === 'aguardando';
  const isPaula = currentUser.role === 'paula';
  const isGestor = currentUser.role === 'gestor';
  
  return `
    <div class="card ${isSpecial ? 'especial' : ''} ${isPublicarAgora ? 'publicar-agora' : ''}">
      <div class="card-header">
        <div class="card-client">
          <div class="client-dot" style="background:${clientColor}"></div>
          <span class="client-name">${item.client}</span>
        </div>
        <span class="card-type ${item.type.toLowerCase()}">${item.type}</span>
      </div>
      
      <div class="card-content ${isSpecial ? 'especial' : ''}">
        ${isSpecial ? '‚≠ê' : ''} ${item.description}
      </div>
      
      <div class="card-info">
        <div class="card-info-item">üìÖ <strong>${item.scheduled_date || '-'}</strong></div>
        <div class="card-info-item">üïê <strong>${item.scheduled_time || '-'}</strong></div>
        <div class="card-info-item">üì± <strong>${item.platform === 'pendente' ? '-' : item.platform}</strong></div>
      </div>
      
      <div class="status-badge ${status.class}">${status.text}</div>
      
      ${item.status === 'aguardando' ? `
        <div class="card-inputs">
          <select class="mini-select" onchange="updateField(${item.id}, 'platform', this.value)">
            <option value="pendente" ${item.platform === 'pendente' ? 'selected' : ''}>Plataforma</option>
            <option value="ekyte" ${item.platform === 'ekyte' ? 'selected' : ''}>Ekyte</option>
            <option value="meta" ${item.platform === 'meta' ? 'selected' : ''}>Meta</option>
            <option value="direto" ${item.platform === 'direto' ? 'selected' : ''}>Direto</option>
          </select>
          <input type="text" class="mini-input" placeholder="Hora" value="${item.scheduled_time || ''}" 
                 onchange="updateField(${item.id}, 'scheduled_time', this.value)">
          <input type="text" class="mini-input" placeholder="Data" value="${item.scheduled_date || ''}" 
                 onchange="updateField(${item.id}, 'scheduled_date', this.value)" style="width:60px">
        </div>
        <div class="card-actions">
          <button class="action-btn primary" onclick="updateStatus(${item.id}, 'agendado')" 
                  ${item.platform === 'pendente' ? 'disabled' : ''}>
            ‚úì Marcar como Agendado
          </button>
        </div>
      ` : ''}
      
      ${item.status === 'agendado' && isGestor ? `
        <div class="checklist">
          <label class="check-item ${item.check_horario ? 'checked' : ''}" onclick="toggleCheck(${item.id}, 'check_horario')">
            <input type="checkbox" ${item.check_horario ? 'checked' : ''}>
            üïê Hor√°rio OK
          </label>
          <label class="check-item ${item.check_visual ? 'checked' : ''}" onclick="toggleCheck(${item.id}, 'check_visual')">
            <input type="checkbox" ${item.check_visual ? 'checked' : ''}>
            üé® Visual OK
          </label>
          <label class="check-item ${item.check_texto ? 'checked' : ''}" onclick="toggleCheck(${item.id}, 'check_texto')">
            <input type="checkbox" ${item.check_texto ? 'checked' : ''}>
            üìù Texto OK
          </label>
        </div>
        <div class="card-actions">
          <button class="action-btn success" onclick="updateStatus(${item.id}, 'verificado')"
                  ${!(item.check_horario && item.check_visual && item.check_texto) ? 'disabled' : ''}>
            ‚úì Tudo OK - Aguardar publicar
          </button>
        </div>
      ` : ''}
      
      ${item.status === 'publicar_agora' && isGestor ? `
        <div class="card-actions">
          <button class="action-btn success" onclick="updateStatus(${item.id}, 'publicado')">
            ‚úÖ Publicado OK
          </button>
          <button class="action-btn danger" onclick="markAsProblem(${item.id})">
            ‚ùå Problema
          </button>
        </div>
      ` : ''}
      
      ${item.status === 'publicado' && isPaula ? `
        <div class="card-actions">
          <button class="action-btn purple" onclick="updateStatus(${item.id}, 'paula_ok')">
            üëÅÔ∏è Paula Conferiu
          </button>
        </div>
      ` : ''}
      
      ${item.status === 'publicado' && item.publicado_ok === false ? `
        <div style="background:rgba(239,68,68,0.1);padding:0.5rem;border-radius:8px;font-size:0.75rem;margin-top:0.5rem;">
          <strong>‚ùå Problema:</strong> ${item.problema_desc || 'N√£o especificado'}
        </div>
      ` : ''}
      
      ${item.verificado_por ? `
        <div style="font-size:0.65rem;color:var(--text-muted);margin-top:0.5rem;">
          Verificado por ${item.verificado_por}
        </div>
      ` : ''}
    </div>
  `;
}

// ========== NOTIFICATIONS ==========
function checkNotifications() {
  const my = getMyItems();
  const toPublish = my.filter(i => i.status === 'publicar_agora');
  const bar = document.getElementById('notificationBar');
  
  if (toPublish.length > 0) {
    bar.classList.add('show');
    document.getElementById('notificationText').textContent = 
      `üîî ${toPublish.length} post${toPublish.length > 1 ? 's' : ''} para verificar no Instagram AGORA!`;
    
    // Tentar tocar som (pode ser bloqueado pelo navegador)
    try {
      if (Notification.permission === 'granted') {
        new Notification('ConectMe Tracker', {
          body: `${toPublish.length} posts para verificar!`,
          icon: 'üìä'
        });
      }
    } catch (e) {}
  } else {
    bar.classList.remove('show');
  }
}

function filterByStatus(status) {
  currentFilter = status === 'publicar_agora' ? 'publicar' : 'todos';
  document.querySelectorAll('.filter-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.filter === currentFilter);
  });
  renderCards();
}

// ========== UTILS ==========
function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = '‚úì ' + msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2000);
}

// ========== INIT ==========
async function init() {
  // Pedir permiss√£o para notifica√ß√µes
  if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission();
  }
  
  await loadData();
  setupRealtime();
  
  // Verificar posts a cada minuto
  setInterval(() => {
    updatePostStatuses();
    checkNotifications();
  }, 60000);
}
</script>
</body>
</html>
